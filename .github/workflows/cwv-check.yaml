name: CWV PR Check

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  run-cwv-check:
    runs-on: ubuntu-latest
    environment: cwv-check-env-junaid  # üîê Use secure environment with secrets

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3 

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install CWV Agent
        run: npm install --no-save git+https://github.com/ramboz/cwv-agent.git

      - name: Print dummy secret for testing
        run: |
          echo "Dummy key from secret: ${{ secrets.DUMMY_TEST_KEY }}"

      - name: Build Preview URL
        id: build_url
        run: |
          BRANCH=${{ github.head_ref }}
          REPO=${{ github.event.repository.name }}
          OWNER=${{ github.repository_owner }}
          PREVIEW_URL="https://${BRANCH}--${REPO}--${OWNER}.aem.page"
          echo "PREVIEW_URL=$PREVIEW_URL" >> $GITHUB_OUTPUT

      - name: Debug PREVIEW_URL
        run: echo "PREVIEW_URL is $PREVIEW_URL"
        env:
          PREVIEW_URL: ${{ steps.build_url.outputs.PREVIEW_URL }}

      - name: Wait for Preview URL to be available
        env:
          PREVIEW_URL: ${{ steps.build_url.outputs.PREVIEW_URL }}
        run: |
          if [ -z "$PREVIEW_URL" ]; then
            echo "ERROR: PREVIEW_URL is empty!"
            exit 2
          fi
          for i in {1..40}; do
            status=$(curl -o /dev/null -s -w "%{http_code}\n" "$PREVIEW_URL")
            if [ "$status" -eq 200 ]; then
              echo "Preview URL is live!"
              exit 0
            fi
            echo "Preview not ready yet (status: $status) for $PREVIEW_URL. Retrying in 15s..."
            sleep 15
          done
          echo "ERROR: Preview URL ($PREVIEW_URL) did not become available in time."
          exit 1

      - name: Run CWV Agent (Mobile & Desktop)
        env:
          PREVIEW_URL: ${{ steps.build_url.outputs.PREVIEW_URL }}
          GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}
          AZURE_OPENAI_API_DEPLOYMENT_NAME: ${{ secrets.AZURE_OPENAI_API_DEPLOYMENT_NAME }}
          AZURE_OPENAI_API_INSTANCE_NAME: ${{ secrets.AZURE_OPENAI_API_INSTANCE_NAME }}
          AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
          AZURE_OPENAI_API_VERSION: ${{ secrets.AZURE_OPENAI_API_VERSION }}
          GOOGLE_PAGESPEED_INSIGHTS_API_KEY: ${{ secrets.GOOGLE_PAGESPEED_INSIGHTS_API_KEY }}
          GOOGLE_CRUX_API_KEY: ${{ secrets.GOOGLE_CRUX_API_KEY }}
        run: |
          if [ -z "$PREVIEW_URL" ]; then
            echo "ERROR: PREVIEW_URL is empty!"
            exit 2
          fi
          node node_modules/cwv-agent/index.js --action prompt --url $PREVIEW_URL --device mobile --model gpt-4o
          node node_modules/cwv-agent/index.js --action prompt --url $PREVIEW_URL --device desktop --model gpt-4o

      - name: Upload CWV Summary Reports (Public Artifact)
        uses: actions/upload-artifact@v4
        with:
          name: cwv-summaries
          path: .cache/*.report.gpt4o.summary.md
          if-no-files-found: warn
          retention-days: 7

      - name: Print project file tree (excluding node_modules)
        run: |
          sudo apt-get update && sudo apt-get install -y tree
          echo "üìÅ Project structure (excluding node_modules):"
          tree -L 3 -a -I 'node_modules'